<html>
<head>
  <script src="flot/jquery.js"></script>
  <script src="flot/jquery.flot.js"></script>  
</head>
<body>
  
  <div id="container" style="width: 100%; height: 150px;">
  </div>
  
  
  <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function () {
      
      // ===============
      // = Chart stuff =
      // ===============
      
      // Setup data containers for the 3 load averages
      // Also specify the total number of points we want in the graph before discarding data
      var data1 = {}, data5 = {}, data15 = {}, totalPoints = 200;
      
      data1["label"] = "1 min";
      data1["data"] = [];

      data5["label"] = "5 min";
      data5["data"] = [];

      data15["label"] = "15 min";
      data15["data"] = [];
      
      // This function adds value to a data array
      var addData = function(value, data) {
        
          // If we got more than totalPoints, we're going to discard older data
          if (data["data"].length >= totalPoints){
            data["data"].shift();
          }
          
          // Add the value to data
          data["data"].push(value);          
      }
      
      var buildPlotData = function(){
        var plotData = [data1, data5, data15];
        
        // Create output that can be read by the plot.
        // zip the generated y values with the x values
        var zipData = function(data){
          var res = [];
          for (var i = 0; i < data["data"].length; ++i)
              res.push([i, data["data"][i]])
          return {"label" : data["label"], data: res};          
        }
        
        return plotData.map(zipData);
      }
      
      // ===============
      // = EventSource =
      // ===============
            
      var openEventSource = function(){        
        // Open a new EventSource (does not work cross-domain)
        var source = new EventSource("/loadavg");
      
        // Listen to the "open" event; we log every time the browser
        // creates a new connection
        source.addEventListener("open", function(){
          if(window.console && window.console.log){
              console.log("Connection opened");
          }
        }, false)
      
        // Listen to the "error" event; we log every time the connection
        // is being closed on us by the other side.
        source.addEventListener('error', function(e) {
          if (e.readyState == EventSource.CLOSED) {
            if(window.console && window.console.log){
              console.log("Connection closed");
            }
          }
        }, false);      
      
        // Listen to the message event. This is where the magic happens!
        // Every time the server sends a message, this event is triggered
        source.addEventListener('message', function(e) {
          
          // We get the load averages in a JSON array 
          // so we have to parse the data here.
          var loadAvg = JSON.parse(e.data);
          
          // Push each value of the array into the respective
          // data object. 
          addData(loadAvg[0] * 1, data1);
          addData(loadAvg[1] * 1, data5);
          addData(loadAvg[2] * 1, data15);
                    
          // Set our newly received data and plot it!
          plot.setData(buildPlotData());
          plot.setupGrid();
          plot.draw();
        }, false);              
      }

      // ==================
      // = Initialisation =
      // ==================
      
      // Setup the Flot chart
      var options = {
        series: { 
          shadowSize: 0 
        }, // drawing is faster without shadows
        xaxis: { 
          show: false 
        },
        yaxis: {
          min: 0
        },
        legend: {
          show: true,
          noColumns: 1,
          position: "sw"
        },
        font: {
          family: "sans-serif"
        }
      };
      
      // Actually put the plot in the container
      plot = $.plot($("#container"), buildPlotData(), options);
      
      // Initialize our eventSource object
      openEventSource();
    });
  </script>
  <style type="text/css" media="screen">
    .tickLabel{
      font-family: sans-serif;
      font-size: 10px;
    }
  </style>
  
</body>
</html>